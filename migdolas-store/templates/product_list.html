{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container my-5">
  <h2 class="mb-4">Mūsų Baldai</h2>
  <div class="row">
    
    <!-- Sidebar: Categories + Filters -->
    <div class="col-md-3 mb-4">
      <h5>Kategorijos</h5>
      <ul class="list-group mb-4">
        <li class="list-group-item {% if not category %}active{% endif %}" data-category="">
          <a href="#" class="text-decoration-none category-link">Visos</a>
        </li>
        {% for cat in categories %}
        <li class="list-group-item {% if cat == category %}active{% endif %}" data-category="{{ cat.slug }}">
          <a href="#" class="text-decoration-none category-link">{{ cat.name }}</a>
        </li>
        {% endfor %}
      </ul>

      <h5>Kaina (€)</h5>
      <div class="mb-3">
        <input type="number" id="minPrice" class="form-control mb-2" placeholder="Nuo">
        <input type="number" id="maxPrice" class="form-control" placeholder="Iki">
      </div>

      <h5>Ieškoti</h5>
      <input type="text" id="searchInput" class="form-control mb-2" placeholder="Ieškoti baldų...">
      
      <button id="filterButton" class="btn btn-primary w-100">Filtruoti</button>
    </div>

    <!-- Main Content: Products -->
    <div class="col-md-9">
      <div class="row" id="productResults">
        {% include 'partials/_product_cards.html' %}
      </div>
    </div>
  </div>
</div>

<div class="dropdown mb-4">
    <button class="btn btn-outline-dark dropdown-toggle" type="button" id="categoryMenu" data-bs-toggle="dropdown" aria-expanded="false">
      Pasirinkite kategoriją
    </button>
    <ul class="dropdown-menu" aria-labelledby="categoryMenu">
      {% for cat in categories %}
        <li class="dropdown-submenu position-relative">
          <a class="dropdown-item dropdown-toggle" href="{% url 'product_list_by_category' cat.slug %}">
            {{ cat.name }}
          </a>
          {% if cat.subcategories.all %}
            <ul class="dropdown-menu">
              {% for sub in cat.subcategories.all %}
                <li><a class="dropdown-item" href="{% url 'product_list_by_category' sub.slug %}">{{ sub.name }}</a></li>
              {% endfor %}
            </ul>
          {% endif %}
        </li>
      {% endfor %}
    </ul>
  </div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  let selectedCategory = "";

  function fetchFilteredProducts() {
    const query = $('#searchInput').val();
    const minPrice = $('#minPrice').val();
    const maxPrice = $('#maxPrice').val();

    $.ajax({
      url: "{% url 'ajax_product_search' %}",
      data: {
        q: query,
        min_price: minPrice,
        max_price: maxPrice,
        category: selectedCategory
      },
      dataType: 'json',
      success: function (data) {
        $('#productResults').html(data.html);
      }
    });
  }

  $('#searchInput').on('input', fetchFilteredProducts);
  $('#filterButton').on('click', fetchFilteredProducts);

  $('.category-link').on('click', function (e) {
    e.preventDefault();
    selectedCategory = $(this).closest('li').data('category');

    $('.list-group-item').removeClass('active');
    $(this).closest('li').addClass('active');

    fetchFilteredProducts();
  });
</script>
{% endblock %}
